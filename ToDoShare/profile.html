<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TodoShare - ë‚´ í”„ë¡œí•„</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header>
    <nav class="container">
      <div class="logo">ğŸ“‹ TodoShare</div>
      <button class="hamburger-menu" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <ul class="nav-menu" id="navMenu"></ul>
    </nav>
  </header>

  <main class="container main-content">
    <h1 class="page-title">ğŸ‘¤ ë‚´ í”„ë¡œí•„</h1>

    <div class="profile-container" id="profileContainer">

      <div class="profile-header">
        <h2 id="profileName" style="margin: 0;"></h2>
      </div>

      <div id="profileAlert"></div>

      <div class="profile-info">
        <label>ì´ë©”ì¼</label>
        <p id="profileEmail"></p>
      </div>

      <div class="profile-info">
        <label>ë‹‰ë„¤ì„</label>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <input 
            type="text" 
            id="nicknameInput" 
            style="flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;"
          >
          <button class="btn" id="updateNicknameBtn" style="min-width: 100px;">ë³€ê²½</button>
        </div>
      </div>

      <div class="profile-info">
        <label>ìê¸°ì†Œê°œ</label>
        <textarea 
          id="bioInput" 
          placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
          style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; min-height: 100px; font-family: inherit;"
        ></textarea>
        <button class="btn btn-secondary" id="updateBioBtn" style="margin-top: 0.5rem;">ì €ì¥</button>
      </div>

      <div class="profile-info">
        <label>ê°€ì… ë‚ ì§œ</label>
        <p id="profileCreatedAt"></p>
      </div>

      <div class="profile-info">
        <label>í†µê³„</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
          <div style="background-color: #f0f0f0; padding: 1rem; border-radius: 4px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #007bff;" id="totalTodos">0</div>
            <div style="color: #666; font-size: 0.9rem;">ì´ í• ì¼</div>
          </div>
          <div style="background-color: #f0f0f0; padding: 1rem; border-radius: 4px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;" id="completedTodos">0</div>
            <div style="color: #666; font-size: 0.9rem;">ì™„ë£Œí•œ í• ì¼</div>
          </div>
          <div style="background-color: #f0f0f0; padding: 1rem; border-radius: 4px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;" id="sharedTodos">0</div>
            <div style="color: #666; font-size: 0.9rem;">ê³µìœ í•œ í• ì¼</div>
          </div>
          <div style="background-color: #f0f0f0; padding: 1rem; border-radius: 4px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;" id="totalLikes">0</div>
            <div style="color: #666; font-size: 0.9rem;">ì´ ì¢‹ì•„ìš”</div>
          </div>
        </div>
      </div>

      <div class="profile-actions">
        <button class="btn btn-secondary" id="changePasswordBtn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        <button class="btn btn-secondary" id="deleteAccountBtn">ê³„ì • ì‚­ì œ</button>
      </div>

      <div id="profileStatusSimple" style="display: flex; flex-direction: column; gap: 0.4rem; margin-top: 1.5rem;">
        <div><span style="font-weight: 700; color: #333;">ë ˆë²¨</span> <span id="profileLevel">1</span></div>
        <div><span style="font-weight: 700; color: #333;">ê²½í—˜ì¹˜</span> <span id="profileXp">0</span> XP</div>
        <div id="profileNextXp"><span style="font-weight: 700; color: #333;">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€</span> 100 XP</div>
        <div><span style="font-weight: 700; color: #333;">ì¹­í˜¸</span> <span id="profileTitle">ìƒˆì‹¹ ë„ì „ì</span></div>
      </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);">
        <span id="closePasswordModal" style="float: right; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</span>
        <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
        <div id="passwordAlert" style="margin-top: 1rem;"></div>
        <div class="form-group" style="margin-top: 1.5rem;">
          <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="currentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div class="form-group">
          <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div class="form-group">
          <label for="confirmNewPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <input type="password" id="confirmNewPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <button class="btn" id="confirmPasswordBtn" style="margin-top: 1rem;">ë³€ê²½í•˜ê¸°</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { getCurrentUser, onAuthChange, getUserInfo, updateNickname } from './js/auth.js';
    import { initializeHeader, enforceAuthPage } from './js/header.js';
    import { db } from './js/firebase-config.js';
    import {
      collection,
      getDocs,
      setDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import {
      updatePassword,
      reauthenticateWithCredential,
      EmailAuthProvider,
      deleteUser
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    let currentUser = null;
    let userInfo = null;

    // ì¸ì¦ ìƒíƒœ ëª¨ë‹ˆí„°ë§
    onAuthChange(user => {
      currentUser = user;
      if (user) {
        initializeHeader();
        setupHamburgerMenu();
        loadProfile();
        loadStats();
      } else {
        window.location.href = 'index.html';
      }
    });

    enforceAuthPage('index.html');

    const profileAlert = document.getElementById('profileAlert');
    const nicknameInput = document.getElementById('nicknameInput');
    const updateNicknameBtn = document.getElementById('updateNicknameBtn');
    const bioInput = document.getElementById('bioInput');
    const updateBioBtn = document.getElementById('updateBioBtn');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');
    const profileCreatedAt = document.getElementById('profileCreatedAt');
    const changePasswordBtn = document.getElementById('changePasswordBtn');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const passwordModal = document.getElementById('passwordModal');
    const closePasswordModal = document.getElementById('closePasswordModal');
    const confirmPasswordBtn = document.getElementById('confirmPasswordBtn');
    const passwordAlert = document.getElementById('passwordAlert');
    const profileLevel = document.getElementById('profileLevel');
    const profileXp = document.getElementById('profileXp');
    const profileNextXp = document.getElementById('profileNextXp');
    const profileTitle = document.getElementById('profileTitle');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const navMenu = document.getElementById('navMenu');

    const BASE_XP_FOR_LEVEL = 100;
    const LEVEL_GROWTH = 25;

    function xpNeededForLevel(level) {
      return BASE_XP_FOR_LEVEL + (level - 1) * LEVEL_GROWTH;
    }

    function computeLevelProgress(xp) {
      let level = 1;
      let xpLeft = xp;

      while (true) {
        const need = xpNeededForLevel(level);
        if (xpLeft < need) {
          return { level, xpIntoLevel: xpLeft, xpNeeded: need };
        }
        xpLeft -= need;
        level += 1;
      }
    }

    function titleForLevel(level) {
      if (level >= 50) return 'ì „ì„¤ì˜ í”Œë˜ë„ˆ';
      if (level >= 33) return 'ì˜í–¥ë ¥ ë¦¬ë”';
      if (level >= 25) return 'ìƒì‚°ì„± ë§ˆìŠ¤í„°';
      if (level >= 18) return 'ì‹œê°„ ì „ëµê°€';
      if (level >= 13) return 'ìŠµê´€ ì¥ì¸';
      if (level >= 9) return 'ëª©í‘œ ë‹¬ì„±ê°€';
      if (level >= 6) return 'ëª°ì…í˜• í¼í¬ë¨¸';
      if (level >= 4) return 'ì„±ì¥í•˜ëŠ” í”Œë˜ë„ˆ';
      if (level >= 2) return 'ê¾¸ì¤€í•œ ì‹¤í–‰ê°€';
      return 'ìƒˆì‹¹ ë„ì „ì';
    }

    // í”„ë¡œí•„ ë¡œë“œ
    async function loadProfile() {
      try {
        if (!currentUser) return;

        userInfo = await getUserInfo(currentUser.uid);
        
        if (userInfo) {
          const xp = userInfo.xp ?? 0;
          const progress = computeLevelProgress(xp);
          const level = userInfo.level ?? progress.level;

          profileName.textContent = userInfo.nickname || 'ì‚¬ìš©ì';
          profileEmail.textContent = currentUser.email;
          profileCreatedAt.textContent = 
            new Date(userInfo.createdAt).toLocaleDateString('ko-KR');
          
          nicknameInput.value = userInfo.nickname || '';
          bioInput.value = userInfo.bio || '';

          profileLevel.textContent = level;
          profileXp.textContent = xp;
          profileNextXp.textContent = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${progress.xpNeeded - progress.xpIntoLevel} XP`;
          profileTitle.textContent = titleForLevel(level);

          // ë ˆë²¨ í•„ë“œ ë³´ì • ì €ì¥
          if (userInfo.level !== level) {
            await updateDoc(doc(db, 'users', currentUser.uid), {
              level: level,
              xp: xp
            });
          }
        }
      } catch (error) {
        console.error('í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // í†µê³„ ë¡œë“œ
    async function loadStats() {
      try {
        if (!currentUser) return;

        const todosQ = query(collection(db, 'todos'), where('uid', '==', currentUser.uid));
        const sharedQ = query(collection(db, 'sharedLists'), where('uid', '==', currentUser.uid));

        const [todosSnap, sharedSnap] = await Promise.all([
          getDocs(todosQ),
          getDocs(sharedQ)
        ]);

        const todos = todosSnap.docs.map(doc => doc.data());
        const sharedLists = sharedSnap.docs.map(doc => doc.data());

        const total = todos.length;
        const completed = todos.filter(t => t.completed).length;
        const sharedCount = sharedLists.length;
        const likes = sharedLists.reduce((sum, s) => sum + (s.likes || 0), 0);

        document.getElementById('totalTodos').textContent = total;
        document.getElementById('completedTodos').textContent = completed;
        document.getElementById('sharedTodos').textContent = sharedCount;
        document.getElementById('totalLikes').textContent = likes;
      } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ë‹‰ë„¤ì„ ë³€ê²½
    updateNicknameBtn.addEventListener('click', async () => {
      const newNickname = nicknameInput.value.trim();

      if (!newNickname) {
        showAlert(profileAlert, 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
      }

      if (newNickname.length < 2 || newNickname.length > 20) {
        showAlert(profileAlert, 'ë‹‰ë„¤ì„ì€ 2ì ì´ìƒ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
        return;
      }

      try {
        await updateNickname(currentUser.uid, newNickname);
        showAlert(profileAlert, 'ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        loadProfile();
      } catch (error) {
        showAlert(profileAlert, 'ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨: ' + error.message, 'error');
      }
    });

    // ìê¸°ì†Œê°œ ì €ì¥
    updateBioBtn.addEventListener('click', async () => {
      try {
        await setDoc(doc(db, 'users', currentUser.uid), {
          bio: bioInput.value
        }, { merge: true });
        showAlert(profileAlert, 'ìê¸°ì†Œê°œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      } catch (error) {
        showAlert(profileAlert, 'ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
      }
    });

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ ì œê±°ë¨

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
    changePasswordBtn.addEventListener('click', () => {
      passwordModal.style.display = 'flex';
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
      passwordAlert.innerHTML = '';
    });

    closePasswordModal.addEventListener('click', () => {
      passwordModal.style.display = 'none';
    });

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™•ì¸
    confirmPasswordBtn.addEventListener('click', async () => {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;

      if (!currentPassword || !newPassword || !confirmNewPassword) {
        showAlert(passwordAlert, 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
      }

      if (newPassword !== confirmNewPassword) {
        showAlert(passwordAlert, 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      if (newPassword.length < 6) {
        showAlert(passwordAlert, 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
        return;
      }

      try {
        // ì¬ì¸ì¦
        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
        await reauthenticateWithCredential(currentUser, credential);

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        await updatePassword(currentUser, newPassword);
        showAlert(passwordAlert, 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

        setTimeout(() => {
          passwordModal.style.display = 'none';
        }, 2000);
      } catch (error) {
        let errorMessage = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨';
        if (error.code === 'auth/wrong-password') {
          errorMessage = 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
        }
        showAlert(passwordAlert, errorMessage, 'error');
      }
    });

    // ê³„ì • ì‚­ì œ
    deleteAccountBtn.addEventListener('click', () => {
      if (confirm('ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        if (confirm('ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤. ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          deleteUserAccount();
        }
      }
    });

    function setupHamburgerMenu() {
      if (!hamburgerBtn || !navMenu) return;

      hamburgerBtn.onclick = (e) => {
        e.stopPropagation();
        hamburgerBtn.classList.toggle('active');
        navMenu.classList.toggle('active');
      };

      navMenu.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
          hamburgerBtn.classList.remove('active');
          navMenu.classList.remove('active');
        }
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('header')) {
          hamburgerBtn.classList.remove('active');
          navMenu.classList.remove('active');
        }
      });
    }

    async function deleteUserAccount() {
      try {
        // ëª¨ë“  í• ì¼ ì‚­ì œ
        const q = query(collection(db, 'todos'), where('uid', '==', currentUser.uid));
        const snapshot = await getDocs(q);
        
        for (const docSnapshot of snapshot.docs) {
          await deleteDoc(doc(db, 'todos', docSnapshot.id));
        }

        // ì‚¬ìš©ì ë°ì´í„° ì‚­ì œ
        await deleteDoc(doc(db, 'users', currentUser.uid));

        // ê³„ì • ì‚­ì œ
        await deleteUser(currentUser);

        alert('ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = 'index.html';
      } catch (error) {
        alert('ê³„ì • ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }

    function showAlert(container, message, type) {
      const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
      container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    }
  </script>
</body>
</html>
