<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TodoShare - 회원가입</title>
  <link rel="icon" href="../favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="../favicon.png">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    body.loading {
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body class="loading">
  <div class="auth-container">
    <div class="auth-form">
      <h1>회원가입</h1>
      <div id="alertMessage"></div>
      <form id="signupForm">
        <div class="form-group">
          <label for="nickname">닉네임</label>
          <input 
            type="text" 
            id="nickname" 
            name="nickname" 
            required
            placeholder="닉네임을 입력하세요"
            minlength="2"
            maxlength="20"
          >
        </div>
        <div class="form-group">
          <label for="email">이메일</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required
            placeholder="your@email.com"
          >
        </div>
        <div class="form-group">
          <label for="password">비밀번호</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            required
            placeholder="비밀번호를 입력하세요"
            minlength="6"
          >
        </div>
        <div class="form-group">
          <label for="confirmPassword">비밀번호 확인</label>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            required
            placeholder="비밀번호를 다시 입력하세요"
            minlength="6"
          >
        </div>
        <button type="submit" class="btn">회원가입</button>
      </form>
      <div class="form-toggle">
        이미 계정이 있으신가요? 
        <a href="../index/">로그인</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { signUp, onAuthChange } from '../js/auth.js';

    // Firebase 인증 초기화 완료 대기
    let initialized = false;
    
    const unsubscribe = onAuthChange(user => {
      if (!initialized) {
        initialized = true;
        
        if (user) {
          // 이미 로그인된 상태 - 대시보드로 이동
          window.location.href = '../dashboard/';
        } else {
          // 미로그인 상태 - 회원가입 페이지 표시
          document.body.classList.remove('loading');
        }
      }
    });

    const signupForm = document.getElementById('signupForm');
    const alertMessage = document.getElementById('alertMessage');

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const nickname = document.getElementById('nickname').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // 유효성 검사
      if (password !== confirmPassword) {
        alertMessage.innerHTML = '<div class="alert alert-error">비밀번호가 일치하지 않습니다.</div>';
        return;
      }

      if (password.length < 6) {
        alertMessage.innerHTML = '<div class="alert alert-error">비밀번호는 최소 6자 이상이어야 합니다.</div>';
        return;
      }

      if (nickname.length < 2 || nickname.length > 20) {
        alertMessage.innerHTML = '<div class="alert alert-error">닉네임은 2자 이상 20자 이하여야 합니다.</div>';
        return;
      }

      try {
        alertMessage.innerHTML = '';
        await signUp(email, password, nickname);
        alertMessage.innerHTML = '<div class="alert alert-success">회원가입 성공! 로그인 페이지로 이동 중...</div>';
        setTimeout(() => {
          window.location.href = '../index/';
        }, 2000);
      } catch (error) {
        let errorMessage = '회원가입 실패했습니다.';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = '이미 사용 중인 이메일입니다.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = '유효하지 않은 이메일 형식입니다.';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = '비밀번호가 너무 약합니다. 6자 이상 입력하세요.';
        }
        
        alertMessage.innerHTML = `<div class="alert alert-error">${errorMessage}</div>`;
      }
    });
  </script>
</body>
</html>
