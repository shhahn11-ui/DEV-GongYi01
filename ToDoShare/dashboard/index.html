<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TodoShare">
  <meta name="theme-color" content="#667eea">
  <title>TodoShare - ê°œì¸ ë¦¬ìŠ¤íŠ¸</title>
  <link rel="icon" href="../favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="../favicon.png">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .status-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .status-card {
      background: #f8f9ff;
      border: 1px solid #e4e7ff;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    }

    .status-label {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
    }

    .status-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: #4a56e2;
      line-height: 1.2;
    }

    .weather-card {
      background: linear-gradient(135deg, #eef2ff 0%, #f7f9ff 100%);
      border: 1px solid #dfe4ff;
      border-radius: 14px;
      padding: 1.35rem 1.5rem;
      margin: 1.4rem 0 1.75rem;
      box-shadow: 0 12px 26px rgba(90, 108, 234, 0.16);
    }

    .weather-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .weather-location {
      font-size: 1.2rem;
      font-weight: 800;
      color: #1f2d3d;
    }

    .weather-date-badge {
      background: #fff;
      border: 1px solid #dfe3f7;
      color: #3f51b5;
      border-radius: 999px;
      padding: 0.2rem 0.7rem;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .weather-toggle-btn {
      margin-left: auto;
      padding: 0.35rem 0.7rem;
      border: 1px solid #dfe3f7;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      color: #1f2d3d;
    }

    .weather-toggle-btn:hover {
      background: #eef2ff;
    }

    .weather-override {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
      align-items: center;
    }

    .weather-override input {
      flex: 1 1 180px;
      padding: 0.45rem 0.6rem;
      border: 1px solid #dfe3f7;
      border-radius: 8px;
      font-size: 0.95rem;
    }

    .weather-override button {
      padding: 0.45rem 0.75rem;
      border: 1px solid #dfe3f7;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      color: #1f2d3d;
    }

    .weather-override button:hover {
      background: #eef2ff;
    }

    .weather-body {
      display: flex;
      gap: 1.25rem;
      align-items: stretch;
      flex-wrap: wrap;
    }

    .weather-left {
      flex: 0 1 280px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem 1.2rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .weather-main {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.75rem 1rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .weather-icon {
      font-size: 2.5rem;
    }

    .weather-temp {
      font-size: 2.6rem;
      font-weight: 900;
      color: #1e2b7b;
      line-height: 1.1;
    }

    .weather-desc {
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      font-weight: 700;
    }

    .weather-minmax {
      color: #4b5563;
      font-weight: 600;
      margin-top: 0.1rem;
    }

    .weather-meta {
      color: #556987;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .weather-advice-panel {
      flex: 1 1 340px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem 1.15rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      min-height: 150px;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .weather-advice-title {
      font-weight: 800;
      color: #1e293b;
      font-size: 1rem;
    }

    .weather-advice {
      color: #1e293b;
      font-weight: 700;
      font-size: 1.45rem;
      line-height: 1.5;
      min-height: 3.6em;
      word-break: keep-all;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .weather-error {
      color: #d14343;
      background: #fff0f0;
      border: 1px solid #f7c4c4;
      padding: 0.65rem 0.8rem;
      border-radius: 8px;
      margin-top: 0.35rem;
      display: none;
    }

    .status-sub {
      color: #666;
      font-size: 0.9rem;
      margin-top: 0.2rem;
    }
    .motivation-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2.5rem 2rem;
      margin-bottom: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      text-align: center;
      animation: slideInDown 0.6s ease-out;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .motivation-label {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .motivation-text {
      font-size: 2rem;
      color: white;
      font-weight: 700;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .motivation-author {
      font-size: 1.05rem;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .motivation-date {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.95);
      font-weight: 500;
    }

    .date-display {
      display: inline;
    }

    /* í• ì¼ ì…ë ¥ */
    .todo-input-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      width: 100%;
      box-sizing: border-box;
    }

    .todo-input-group input[type="text"],
    .todo-input-group input[type="date"],
    .todo-input-group select {
      flex: 1;
      min-width: 120px;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
      box-sizing: border-box;
      max-width: 100%;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .todo-input-group select {
      text-align: center;
      text-align-last: center;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    /* í• ì¼ í•­ëª© */
    .todo-list {
      list-style: none;
    }

    .todo-section-group {
      margin-bottom: 2rem;
    }

    .todo-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .todo-section-label {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #667eea;
      flex: 1;
      margin: 0;
      animation: slideInLeft 0.5s ease-out;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(30px);
      }
    }

    @keyframes slideOutLeft {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-30px);
      }
    }

    .todo-item.removing {
      animation: slideOutRight 0.4s ease-in forwards;
    }

    .btn-delete-all {
      background: #ff9800;
      color: white;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .btn-delete-all:hover {
      background: #f57c00;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: white;
      border: 1px solid #eee;
      border-radius: 4px;
      margin-bottom: 0.75rem;
      animation: fadeInUp 0.4s ease-out;
      transition: all 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .todo-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .todo-item.completed {
      background: #f9f9f9;
      opacity: 0.7;
      animation: fadeOut 0.3s ease-in;
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0.7;
        transform: scale(0.98);
      }
    }

    .todo-item.completed .todo-text {
      text-decoration: line-through;
      color: #999;
    }

    .todo-select {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .todo-text {
      flex: 1;
      font-weight: 500;
    }

    .todo-category {
      background: #e3f2fd;
      color: #1976d2;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .todo-date {
      background: #fff3e0;
      color: #e65100;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }

    .todo-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 3px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      transform-origin: center;
    }

    .btn-small:active {
      transform: scale(0.95);
    }

    .btn-complete {
      background: #4caf50;
      color: white;
    }

    .btn-complete:hover {
      background: #45a049;
      animation: pulse 0.3s ease;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .btn-delete {
      background: #f44336;
      color: white;
    }

    .btn-delete:hover {
      background: #da190b;
      animation: shake 0.3s ease;
    }

    @keyframes shake {
      0%, 100% {
        transform: translateX(0);
      }
      25% {
        transform: translateX(-3px);
      }
      75% {
        transform: translateX(3px);
      }
    }

    .btn-danger {
      background: #f44336;
      color: white;
      padding: 0.65rem 1.2rem;
      border: none;
      border-radius: 4px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: #999;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .empty-state p {
      font-size: 1rem;
      color: #666;
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
    @media (max-width: 768px) {
      body {
        overflow-x: hidden;
      }

      .container {
        padding: 0 15px;
        max-width: 100%;
        overflow-x: hidden;
      }

      /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ì¡°ì • */
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        position: relative;
      }

      /* í–„ë²„ê±° ë©”ë‰´ í‘œì‹œ */
      .hamburger-menu {
        display: flex !important;
        margin-left: auto;
        padding: 0.5rem 0;
      }

      .nav-menu {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        background-color: white;
        flex-direction: column;
        gap: 0;
        padding: 1rem 0;
        display: none !important;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        list-style: none;
      }

      .nav-menu.active {
        display: flex !important;
      }

      .nav-menu li {
        list-style: none;
      }

      .nav-menu a {
        display: block;
        padding: 1rem 2rem;
        border-bottom: 1px solid #eee;
        text-decoration: none;
        color: #333;
      }

      .nav-menu a:hover {
        background-color: #f5f5f5;
      }

      .nav-menu .btn-logout {
        margin: 1rem 2rem;
        width: calc(100% - 4rem);
      }

      .motivation-box {
        padding: 2rem 1.5rem;
        margin-bottom: 1.5rem;
      }

      .motivation-text {
        font-size: 1.5rem;
      }

      .todo-input-group {
        flex-direction: column;
        gap: 0.75rem;
      }

      .todo-input-group input[type="text"],
      .todo-input-group input[type="date"],
      .todo-input-group select,
      .btn {
        width: 100% !important;
        min-width: unset !important;
        max-width: 100% !important;
        flex: none !important;
        box-sizing: border-box;
      }

      .todo-item {
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .todo-select {
        flex-shrink: 0;
      }

      .todo-text {
        flex: 1 1 100%;
        min-width: 0;
        word-break: break-word;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .todo-meta {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        flex: 1 1 auto;
        flex-wrap: wrap;
      }

      .todo-category,
      .todo-date {
        flex: 0 0 auto;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
      }

      .todo-actions {
        flex: 1 1 100%;
        gap: 0.5rem;
      }

      .btn-small {
        flex: 1;
        padding: 0.5rem 0.6rem;
        font-size: 0.8rem;
      }

      .todo-section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      .todo-section-label {
        margin-bottom: 0;
        font-size: 1rem;
      }

      .btn-delete-all {
        width: 100%;
      }

      .category-filter {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .category-btn {
        flex-shrink: 0;
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
      }

      .page-title {
        font-size: 1.8rem !important;
      }

      .motivation-label {
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      .todo-input-group {
        gap: 0.5rem;
      }

      .todo-input-group input,
      .todo-input-group input[type="text"],
      .todo-input-group input[type="date"],
      .todo-input-group select,
      .btn {
        padding: 0.6rem;
        font-size: 0.9rem;
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        flex: none !important;
        box-sizing: border-box;
      }

      .todo-input-group select {
        text-align: center;
        text-align-last: center;
      }

      .todo-item {
        padding: 0.75rem;
        gap: 0.5rem;
      }

      .todo-meta {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        flex: 1 1 auto;
      }

      .todo-text {
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .todo-category,
      .todo-date {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
      }

      .btn-small {
        padding: 0.3rem 0.4rem;
        font-size: 0.7rem;
        white-space: nowrap;
      }

      .motivation-box {
        padding: 1.5rem 1rem;
      }

      .motivation-text {
        font-size: 1.2rem;
      }

      .page-title {
        font-size: 1.5rem !important;
      }
    }

  </style>
</head>
<body>
  <header>
    <nav class="container">
      <div class="logo">ğŸ“‹ TodoShare</div>
      <button class="hamburger-menu" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <ul class="nav-menu" id="navMenu"></ul>
    </nav>
  </header>

  <main class="container main-content">
    <h1 class="page-title">My Todo.</h1>
    <p style="color: #666; margin-bottom: 2rem; font-size: 1.1rem;">ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ë‹¬ì„±í•´ë³´ì„¸ìš”</p>

    <!-- ì‘ì› ë°•ìŠ¤ -->
    <div class="motivation-box" id="motivationBox">
      <div class="motivation-label">ğŸŒŸ ì˜¤ëŠ˜ì˜ ì‘ì›</div>
      <div class="motivation-text" id="motivationText"></div>
      <div class="motivation-author" id="motivationAuthor"></div>
      <div class="motivation-date">
        <div class="date-display">
          <span id="dateDisplay"></span>
        </div>
      </div>
    </div>

    <div class="status-row">
      <div class="status-card">
        <div class="status-label">ë ˆë²¨</div>
        <div class="status-value" id="levelValue">1</div>
      </div>
      <div class="status-card">
        <div class="status-label">ê²½í—˜ì¹˜</div>
        <div class="status-value" style="font-size: 1.4rem;">
          <span id="xpValue">0</span> XP
        </div>
        <div class="status-sub" id="xpProgressText">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ 100 XP</div>
      </div>
      <div class="status-card">
        <div class="status-label">ì¹­í˜¸</div>
        <div class="status-value" style="font-size: 1.1rem;" id="titleValue">ìƒˆì‹¹ ë„ì „ì</div>
        <div class="status-sub" id="nextTitleText">ë‹¤ìŒ ì¹­í˜¸: ê¾¸ì¤€í•œ ì‹¤í–‰ê°€ (Lv. 2)</div>
      </div>
    </div>

    <div class="weather-card" id="weatherCard">
      <div class="weather-header">
        <div class="weather-location" id="weatherLocation">ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
        <div class="weather-date-badge" id="weatherDate">--.--</div>
        <button class="weather-toggle-btn" id="toggleLocationBtn" type="button">ì„¤ì •</button>
      </div>
      <div class="weather-override" style="display: none;">
        <input id="customLocationInput" type="text" placeholder="ë„ì‹œ/êµ¬ ì…ë ¥ (ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬)" aria-label="ì‚¬ìš©ì ìœ„ì¹˜ ì…ë ¥">
        <button id="setLocationBtn" type="button">ì ìš©</button>
        <button id="clearLocationBtn" type="button">ì´ˆê¸°í™”</button>
      </div>
      <div class="weather-body">
        <div class="weather-left">
          <div class="weather-main">
            <div class="weather-icon" id="weatherIcon">â›…</div>
            <div>
              <div class="weather-temp" id="weatherTemp">--Â°</div>
              <div class="weather-desc" id="weatherDesc">ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              <div class="weather-minmax" id="weatherMinMax">ìµœì € --Â° Â· ìµœê³  --Â°</div>
            </div>
          </div>
          <div class="weather-meta" id="weatherMeta"></div>
        </div>
        <div class="weather-advice-panel">
          <div class="weather-advice-title">ì˜¤ëŠ˜ì˜ ê³„íš ì¡°ì–¸</div>
          <div class="weather-advice" id="weatherAdvice">ì˜¤ëŠ˜ì˜ ê³„íš ì¡°ì–¸ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
          <div class="weather-error" id="weatherError"></div>
        </div>
      </div>
    </div>

    <div class="todo-section">
      <div class="todo-input-group">
        <input 
          type="text" 
          id="todoInput" 
          placeholder="í•  ì¼ì„ ì…ë ¥í•´ë³´ì„¸ìš”..."
        >
        <input 
          type="date" 
          id="todoDate"
          min=""
        >
        <select id="categorySelect">
          <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
          <option value="ê±´ê°•">ê±´ê°•</option>
          <option value="ê³µë¶€">ê³µë¶€</option>
          <option value="í—¬ìŠ¤">í—¬ìŠ¤</option>
          <option value="ì¼">ì¼</option>
          <option value="ì·¨ë¯¸">ì·¨ë¯¸</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
        <button class="btn" id="addTodoBtn">ì¶”ê°€</button>
      </div>

      <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button class="btn btn-danger" id="deleteSelectedBtn" style="display: none;">ì„ íƒ ì‚­ì œ</button>
      </div>

      <div class="category-filter">
        <button class="category-btn active" data-category="">ì „ì²´</button>
        <button class="category-btn" data-category="ê±´ê°•">ê±´ê°•</button>
        <button class="category-btn" data-category="ê³µë¶€">ê³µë¶€</button>
        <button class="category-btn" data-category="í—¬ìŠ¤">í—¬ìŠ¤</button>
        <button class="category-btn" data-category="ì¼">ì¼</button>
        <button class="category-btn" data-category="ì·¨ë¯¸">ì·¨ë¯¸</button>
        <button class="category-btn" data-category="ê¸°íƒ€">ê¸°íƒ€</button>
      </div>

      <ul class="todo-list" id="todoList"></ul>
      <div id="emptyMessage" class="empty-state" style="display: none;">
        <div class="empty-state-icon">ğŸ“­</div>
        <p>í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í• ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
      </div>
    </div>
  </main>

  <script type="module">
    import { getCurrentUser, onAuthChange } from '../js/auth.js';
    import { initializeHeader, enforceAuthPage } from '../js/header.js';
    import { db } from '../js/firebase-config.js';
    import {
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      updateDoc,
      doc,
      query,
      where,
      orderBy,
      Timestamp,
      getDoc,
      runTransaction,
      limit
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    let todos = [];
    let currentFilter = '';
    let currentUser = null;
    let selectedTodos = new Set(); // ì„ íƒëœ í• ì¼ ID ì €ì¥
    let userStats = { xp: 0, level: 1 };

    const XP_PER_TODO = 10;
    const BASE_XP_FOR_LEVEL = 100; // 1->2 í•„ìš”í•œ ê¸°ë³¸ XP
    const LEVEL_GROWTH = 25;       // ë ˆë²¨ë§ˆë‹¤ ì¶”ê°€ë¡œ ëŠ˜ì–´ë‚˜ëŠ” XP

    // ì‘ì› ê¸€ê·€ ëª©ë¡ (ì‹¤ì œ ëª…ì–¸ + í™”ì)
    const motivations = [
      { text: "ì„±ê³µì€ ì—´ì •ì„ ìƒì§€ ì•Šê³  ì‹¤íŒ¨ì—ì„œ ì‹¤íŒ¨ë¡œ ê±¸ì–´ê°€ëŠ” ê²ƒì´ë‹¤.", author: "ìœˆìŠ¤í„´ ì²˜ì¹ " },
      { text: "ë‚´ì¼ ì£½ì„ ê²ƒì²˜ëŸ¼ ì˜¤ëŠ˜ì„ ì‚´ê³ , ì˜ì›íˆ ì‚´ ê²ƒì²˜ëŸ¼ ë°°ì›Œë¼.", author: "ë§ˆí•˜íŠ¸ë§ˆ ê°„ë””" },
      { text: "í–‰ë™ì€ ëª¨ë“  ì„±ê³µì˜ ê¸°ì´ˆì´ë‹¤.", author: "íŒŒë¸”ë¡œ í”¼ì¹´ì†Œ" },
      { text: "ìœ„ëŒ€í•œ ì¼ì„ í•˜ëŠ” ìœ ì¼í•œ ë°©ë²•ì€ ë‹¹ì‹ ì´ í•˜ëŠ” ì¼ì„ ì‚¬ë‘í•˜ëŠ” ê²ƒì´ë‹¤.", author: "ìŠ¤í‹°ë¸Œ ì¡ìŠ¤" },
      { text: "ì²œì¬ëŠ” 1%ì˜ ì˜ê°ê³¼ 99%ì˜ ë•€ì´ë‹¤.", author: "í† ë¨¸ìŠ¤ ì—ë””ìŠ¨" },
      { text: "ìš°ë¦¬ê°€ ë‘ë ¤ì›Œí•´ì•¼ í•  ê²ƒì€ ë‘ë ¤ì›€ ìì²´ë¿ì´ë‹¤.", author: "í”„ë­í´ë¦° D. ë£¨ìŠ¤ë²¨íŠ¸" },
      { text: "ê¾¸ì¤€í•œ ë…¸ë ¥ì€ í˜ì´ ëœë‹¤.", author: "ìš”í•œ ë³¼í”„ê°• í° ê´´í…Œ" },
      { text: "ë‚˜ëŠ” ì‹¤íŒ¨í•œ ì ì´ ì—†ë‹¤. ë‹¤ë§Œ ì˜ ì•ˆ ë˜ëŠ” 1ë§Œ ê°€ì§€ ë°©ë²•ì„ ë°œê²¬í–ˆì„ ë¿ì´ë‹¤.", author: "í† ë¨¸ìŠ¤ ì—ë””ìŠ¨" },
      { text: "í–‰ë³µì€ ì¤€ë¹„ëœ ì‚¬ëŒì—ê²Œë§Œ ì°¾ì•„ì˜¤ëŠ” í–‰ìš´ì´ë‹¤.", author: "ë£¨ì´ íŒŒìŠ¤í‡´ë¥´" },
      { text: "ì§€ê¸ˆì´ ë°”ë¡œ ê·¸ ìˆœê°„ì´ë‹¤.", author: "ë§ˆë¦¬ í€´ë¦¬" }
    ];

    // ì‘ì› ê¸€ê·€ ì„¤ì •
    function setMotivation() {
      const randomIndex = Math.floor(Math.random() * motivations.length);
      const quote = motivations[randomIndex];
      const motivationText = document.getElementById('motivationText');
      const motivationAuthor = document.getElementById('motivationAuthor');
      motivationText.textContent = `"${quote.text}"`;
      motivationAuthor.textContent = `${quote.author}`;
      
      // ë‚ ì§œ ì„¤ì •
      const today = new Date();
      const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
      const dateDisplay = document.getElementById('dateDisplay');
      dateDisplay.textContent = today.toLocaleDateString('ko-KR', dateOptions);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‘ì› ê¸€ê·€ ì„¤ì •
    setMotivation();

    // ì¸ì¦ ìƒíƒœ ëª¨ë‹ˆí„°ë§
    onAuthChange(user => {
      currentUser = user;
      if (user) {
        initializeHeader();
        loadUserStats();
        loadTodos();
        setupHamburgerMenu(); // í–„ë²„ê±° ë©”ë‰´ ì´ˆê¸°í™”
        loadWeather();
      } else {
        window.location.href = '../index.html';
      }
    });

    enforceAuthPage('../index.html');

    const todoInput = document.getElementById('todoInput');
    const todoDate = document.getElementById('todoDate');
    const categorySelect = document.getElementById('categorySelect');
    const addTodoBtn = document.getElementById('addTodoBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const todoList = document.getElementById('todoList');
    const emptyMessage = document.getElementById('emptyMessage');
    const categoryButtons = document.querySelectorAll('.category-btn');
    const levelValue = document.getElementById('levelValue');
    const xpValue = document.getElementById('xpValue');
    const xpProgressText = document.getElementById('xpProgressText');
    const titleValue = document.getElementById('titleValue');
    const nextTitleText = document.getElementById('nextTitleText');
    const weatherLocation = document.getElementById('weatherLocation');
    const weatherDate = document.getElementById('weatherDate');
    const weatherIcon = document.getElementById('weatherIcon');
    const weatherTemp = document.getElementById('weatherTemp');
    const weatherDesc = document.getElementById('weatherDesc');
    const weatherMinMax = document.getElementById('weatherMinMax');
    const weatherMeta = document.getElementById('weatherMeta');
    const weatherAdvice = document.getElementById('weatherAdvice');
    const weatherError = document.getElementById('weatherError');
    const customLocationInput = document.getElementById('customLocationInput');
    const setLocationBtn = document.getElementById('setLocationBtn');
    const clearLocationBtn = document.getElementById('clearLocationBtn');
    const toggleLocationBtn = document.getElementById('toggleLocationBtn');
    const weatherOverride = document.querySelector('.weather-override');

    function resetFilterToAll() {
      currentFilter = '';
      categoryButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === '');
      });
    }

    // ë¡œì»¬ íƒ€ì„ì¡´ ê¸°ì¤€ YYYY-MM-DD ë¬¸ìì—´ ë°˜í™˜
    function formatLocalDate(daysOffset = 0) {
      const date = new Date();
      date.setDate(date.getDate() + daysOffset);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatWeatherDate(date = new Date()) {
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${month}.${day}`;
    }

    async function fetchNominatimKo(latitude, longitude) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}&accept-language=ko`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) return null;
        const data = await res.json();
        const addr = data?.address || {};
        const city = addr.city || addr.town || addr.village;
        const district = addr.county || addr.state_district;
        const province = addr.state;
        const country = addr.country;
        const parts = [city, district].filter(Boolean);
        const label = parts.length ? parts.join(' ') : (province || country || 'í˜„ì¬ ìœ„ì¹˜');
        return { label, raw: addr };
      } catch (e) {
        console.warn('Nominatim ì—­ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', e);
        return null;
      }
    }

    async function fetchCityName(latitude, longitude) {
      try {
        const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&language=ko&count=1`;
        const res = await fetch(url);
        if (!res.ok) return await fetchNominatimKo(latitude, longitude);
        const data = await res.json();
        const place = data?.results?.[0];
        if (!place) return await fetchNominatimKo(latitude, longitude);
        // ìš°ì„ ìˆœìœ„: city/locality > admin2(êµ¬/êµ°) > admin1(ë„) > country
        const city = place.city || place.locality || place.name;
        const admin2 = place.admin2;
        const admin1 = place.admin1;
        const country = place.country;
        const parts = [city, admin2].filter(Boolean);
        let region = parts.length ? parts.join(' ') : (admin1 || country || 'í˜„ì¬ ìœ„ì¹˜');

        // ì˜ì–´ê°€ ì„ì—¬ ìˆìœ¼ë©´ í•œêµ­ì–´ ëŒ€ì•ˆ ì‹œë„
        if (/[A-Za-z]/.test(region)) {
          const alt = await fetchNominatimKo(latitude, longitude);
          if (alt?.label) region = alt.label;
        }

        return { label: region, raw: place };
      } catch (e) {
        console.warn('ì—­ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', e);
        const alt = await fetchNominatimKo(latitude, longitude);
        return alt;
      }
    }

    async function fetchIpLocation() {
      try {
        const res = await fetch('https://ipapi.co/json/');
        if (!res.ok) return null;
        const data = await res.json();
        if (!data || !data.latitude || !data.longitude) return null;
        const city = data.city || '';
        const region = data.region || '';
        const label = [city, region].filter(Boolean).join(' ') || 'í˜„ì¬ ìœ„ì¹˜';
        return {
          latitude: data.latitude,
          longitude: data.longitude,
          label
        };
      } catch (e) {
        console.warn('IP ê¸°ë°˜ ìœ„ì¹˜ ì¡°íšŒ ì‹¤íŒ¨:', e);
        return null;
      }
    }

    function loadCustomLocation() {
      try {
        const raw = localStorage.getItem(CUSTOM_LOCATION_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (parsed && parsed.latitude && parsed.longitude && parsed.label) return parsed;
        return null;
      } catch (e) {
        return null;
      }
    }

    function saveCustomLocation(data) {
      localStorage.setItem(CUSTOM_LOCATION_KEY, JSON.stringify(data));
    }

    function clearCustomLocation() {
      localStorage.removeItem(CUSTOM_LOCATION_KEY);
    }

    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
    const today = formatLocalDate();
    todoDate.value = today;
    todoDate.min = today; // ì§€ë‚œ ë‚ ì§œ ì„ íƒ ë¶ˆê°€

    const DEFAULT_LOCATION = {
      latitude: 37.5665,
      longitude: 126.9780,
      label: 'ì„œìš¸(ê¸°ë³¸)'
    };
    const CUSTOM_LOCATION_KEY = 'custom_location_override';

    const WEATHER_CODE_MAP = {
      0: 'ë§‘ìŒ',
      1: 'ëŒ€ì²´ë¡œ ë§‘ìŒ',
      2: 'ì•½ê°„ íë¦¼',
      3: 'íë¦¼',
      45: 'ì•ˆê°œ',
      48: 'ì•ˆê°œ',
      51: 'ì´ìŠ¬ë¹„',
      53: 'ì´ìŠ¬ë¹„',
      55: 'ê°•í•œ ì´ìŠ¬ë¹„',
      61: 'ì•½í•œ ë¹„',
      63: 'ì¤‘ê°„ ë¹„',
      65: 'ê°•í•œ ë¹„',
      71: 'ê°€ë²¼ìš´ ëˆˆ',
      73: 'ì¤‘ê°„ ëˆˆ',
      75: 'ê°•í•œ ëˆˆ',
      80: 'ì†Œë‚˜ê¸°',
      81: 'ê°•í•œ ì†Œë‚˜ê¸°',
      82: 'ë§¤ìš° ê°•í•œ ì†Œë‚˜ê¸°',
      85: 'ì†Œë‚™ëˆˆ',
      86: 'ê°•í•œ ì†Œë‚™ëˆˆ',
      95: 'ì²œë‘¥ ë²ˆê°œ',
      96: 'ì•½í•œ ìš°ë°•',
      99: 'ê°•í•œ ìš°ë°•'
    };

    const WEATHER_ICON_MAP = {
      0: 'â˜€ï¸',
      1: 'ğŸŒ¤ï¸',
      2: 'â›…',
      3: 'â˜ï¸',
      45: 'ğŸŒ«ï¸',
      48: 'ğŸŒ«ï¸',
      51: 'ğŸŒ¦ï¸',
      53: 'ğŸŒ¦ï¸',
      55: 'ğŸŒ§ï¸',
      61: 'ğŸŒ§ï¸',
      63: 'ğŸŒ§ï¸',
      65: 'â›ˆï¸',
      71: 'ğŸŒ¨ï¸',
      73: 'ğŸŒ¨ï¸',
      75: 'â„ï¸',
      80: 'ğŸŒ¦ï¸',
      81: 'ğŸŒ§ï¸',
      82: 'â›ˆï¸',
      85: 'ğŸŒ¨ï¸',
      86: 'â„ï¸',
      95: 'â›ˆï¸',
      96: 'â›ˆï¸',
      99: 'â›ˆï¸'
    };

    // í• ì¼ ì¶”ê°€
    addTodoBtn.addEventListener('click', async () => {
      const text = todoInput.value.trim();
      const category = categorySelect.value;
      const dueDate = todoDate.value;

      if (!text) {
        alert('í• ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      if (!category) {
        alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      if (!dueDate) {
        alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      try {
        const newDoc = await addDoc(collection(db, 'todos'), {
          uid: currentUser.uid,
          text: text,
          category: category,
          dueDate: dueDate,
          completed: false,
          completedDate: null,
          createdAt: Timestamp.now(),
          shared: false
        });

        console.log('âœ… í• ì¼ ì¶”ê°€ ì„±ê³µ:', newDoc.id);
        todoInput.value = '';
        todoDate.value = today;
        categorySelect.value = '';
        resetFilterToAll();
        await loadTodos();
      } catch (error) {
        console.error('âŒ í• ì¼ ì¶”ê°€ ì˜¤ë¥˜:', error.code, error.message);
        alert('í• ì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ' + error.message);
      }
    });


    // Enter í‚¤ë¡œ í• ì¼ ì¶”ê°€
    todoInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addTodoBtn.click();
      }
    });

    // í• ì¼ ëª©ë¡ ë¡œë“œ
    async function loadTodos(retryCount = 0) {
      try {
        if (!currentUser) {
          console.warn('âš ï¸ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        console.log('ğŸ“¥ í• ì¼ ë¡œë“œ ì‹œì‘, UID:', currentUser.uid);

        const q = query(
          collection(db, 'todos'),
          where('uid', '==', currentUser.uid)
        );

        const snapshot = await getDocs(q);
        todos = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // ê¸°í•œì´ ì§€ë‚œ ëª¨ë“  í• ì¼ ìë™ ì‚­ì œ (ì™„ë£Œ ì—¬ë¶€ì™€ ë¬´ê´€)
        const today = formatLocalDate();
        for (let todo of todos) {
          if (todo.dueDate && todo.dueDate < today) {
            console.log('ğŸ—‘ï¸ ê¸°í•œ ì§€ë‚œ í•­ëª© ì‚­ì œ:', todo.id);
            await deleteDoc(doc(db, 'todos', todo.id));
          }
        }

        // ë‹¤ì‹œ ë¡œë“œ (ì‚­ì œëœ í•­ëª© ì œì™¸)
        const snapshot2 = await getDocs(q);
        todos = snapshot2.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // ë‚ ì§œìˆœ ì •ë ¬ (ë¹ ë¥¸ ê¸°í•œìˆœ)
        todos.sort((a, b) => {
          const dateA = a.dueDate || '9999-12-31';
          const dateB = b.dueDate || '9999-12-31';
          return dateA.localeCompare(dateB);
        });

        console.log('âœ… í• ì¼ ë¡œë“œ ì™„ë£Œ:', todos.length + 'ê°œ');
        renderTodos();
      } catch (error) {
        console.error('âŒ í• ì¼ ë¡œë“œ ì˜¤ë¥˜:', error.code, error.message);

        const retriableCodes = ['unavailable', 'unknown', 'deadline-exceeded'];
        if (retriableCodes.includes(error.code) && retryCount < 2) {
          const waitMs = 1200 * (retryCount + 1);
          console.warn(`ğŸ” ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ë³€ê²½ ê°ì§€, ${waitMs}ms í›„ ì¬ì‹œë„...`);
          await new Promise(resolve => setTimeout(resolve, waitMs));
          return loadTodos(retryCount + 1);
        }
      }
    }

    function buildAdvice({ temperature, precipitation, wind }) {
      const advice = [];

      if (precipitation >= 1) {
        advice.push('ë¹„ê°€ ì™€ìš”! â˜” ì˜¤ëŠ˜ì€ ì§‘ì½•í•˜ë©° ì •ë¦¬ë‚˜ ê³µë¶€ ê°™ì€ ì”ì”í•œ ì¼ì •ì„ ì±™ê²¨ë³´ì£ .');
      } else if (temperature >= 28) {
        advice.push('ì¢€ ë”ìš´ ë‚ ì”¨ì˜ˆìš”! ğŸŒ ì§§ì€ ì™¸ì¶œ + ê°€ë²¼ìš´ ì—…ë¬´ë¡œ ì—ë„ˆì§€ ì•„ê»´ë´ìš”.');
      } else if (temperature <= 3) {
        advice.push('ê³µê¸°ê°€ ìŒ€ìŒ€í•´ìš”! ğŸ§£ ë”°ëœ»í•˜ê²Œ ì…ê³  ì‹¤ë‚´ í™œë™ ìœ„ì£¼ë¡œ ê³„íší•´ìš”.');
      } else {
        advice.push('ì»¨ë””ì…˜ ì¢‹ì€ ë‚ ì”¨ì˜ˆìš”! ğŸš¶â€â™‚ï¸ ê°€ë²¼ìš´ ì‚°ì±…ì´ë‚˜ ìš´ë™ì„ ì¼ì •ì— ë„£ì–´ë„ ì¢‹ì•„ìš”.');
      }

      if (wind >= 10) {
        advice.push('ë°”ëŒì´ ì œë²• ë¶ˆì–´ìš”! ğŸ’¨ ì´ë™ì€ ì—¬ìœ  ìˆê²Œ, ì‹¤ë‚´ í•  ì¼ì„ ë¨¼ì € ë°°ì¹˜í•´ìš”.');
      }

      if (precipitation === 0 && temperature >= 12 && temperature <= 26) {
        advice.push('ì§‘ì¤‘í•˜ê¸° ì¢‹ì€ ê¸°ì˜¨ì´ì—ìš”! âœ¨ ì¤‘ìš”í•œ ì¼ì„ ì•ìª½ì— ë°°ì¹˜í•´ë³´ì„¸ìš”.');
      }

      return advice.join(' ');
    }

    async function fetchWeather(latitude, longitude) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,precipitation,weathercode,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&forecast_days=1&timezone=auto`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('ë‚ ì”¨ API í˜¸ì¶œ ì‹¤íŒ¨');
      const data = await res.json();
      const current = data.current;
      const daily = data.daily;

      return {
        temperature: current?.temperature_2m,
        apparent: current?.apparent_temperature,
        precipitation: current?.precipitation ?? 0,
        weatherCode: current?.weathercode,
        wind: current?.wind_speed_10m,
        minTemp: daily?.temperature_2m_min?.[0],
        maxTemp: daily?.temperature_2m_max?.[0],
        timezone: data.timezone
      };
    }

    function setWeatherError(message) {
      weatherError.style.display = 'block';
      weatherError.textContent = message;
      weatherDesc.textContent = 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      weatherTemp.textContent = '--Â°';
      weatherMinMax.textContent = 'ìµœì € --Â° Â· ìµœê³  --Â°';
      weatherMeta.textContent = '';
      weatherIcon.textContent = 'â„¹ï¸';
      weatherAdvice.textContent = 'ê¸°ë³¸ ê³„íšì„ ìœ ì§€í•˜ì„¸ìš”.';
      if (weatherOverride) weatherOverride.style.display = 'flex';
    }

    function renderWeather({ locationLabel, weather }) {
      const description = WEATHER_CODE_MAP[weather.weatherCode] || 'ë‚ ì”¨ ì •ë³´';
      const icon = WEATHER_ICON_MAP[weather.weatherCode] || 'â›…';
      const temperature = Number.isFinite(weather.temperature) ? Math.round(weather.temperature) : '--';
      const apparent = Number.isFinite(weather.apparent) ? Math.round(weather.apparent) : null;
      const precipitation = Number.isFinite(weather.precipitation) ? weather.precipitation : 0;
      const wind = Number.isFinite(weather.wind) ? weather.wind : 0;
      const minTempVal = Number.isFinite(weather.minTemp) ? Math.round(weather.minTemp) : null;
      const maxTempVal = Number.isFinite(weather.maxTemp) ? Math.round(weather.maxTemp) : null;

      weatherDate.textContent = formatWeatherDate();
      weatherLocation.textContent = locationLabel;
      weatherIcon.textContent = icon;
      weatherTemp.textContent = `${temperature}Â°`;
      weatherDesc.textContent = description;
      if (minTempVal !== null && maxTempVal !== null) {
        weatherMinMax.textContent = `ìµœì € ${minTempVal}Â° Â· ìµœê³  ${maxTempVal}Â°`;
      } else {
        weatherMinMax.textContent = 'ìµœì € --Â° Â· ìµœê³  --Â°';
      }

      const apparentText = apparent !== null ? `${apparent}Â°` : '--Â°';
      weatherMeta.textContent = `ì²´ê° ${apparentText} Â· ê°•ìˆ˜ ${precipitation.toFixed(1)}mm Â· í’ì† ${wind.toFixed(1)}m/s`;
      weatherAdvice.textContent = buildAdvice({
        temperature: temperature === '--' ? 0 : temperature,
        precipitation,
        wind
      });
      weatherError.style.display = 'none';
    }

    async function applyCustomLocation() {
      const query = (customLocationInput.value || '').trim();
      if (!query) {
        alert('ë„ì‹œë‚˜ êµ¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      try {
        setLocationBtn.disabled = true;
        setLocationBtn.textContent = 'ì ìš© ì¤‘...';
        const encoded = encodeURIComponent(query);
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&accept-language=ko&q=${encoded}`);
        if (!res.ok) throw new Error('ìœ„ì¹˜ ê²€ìƒ‰ ì‹¤íŒ¨');
        const data = await res.json();
        const item = data?.[0];
        if (!item) {
          alert('í•´ë‹¹ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ì…ë ¥í•´ ë³´ì„¸ìš”.');
          return;
        }
        const lat = parseFloat(item.lat);
        const lon = parseFloat(item.lon);
        const display = item.display_name?.split(',')?.[0] || query;
        const saved = { latitude: lat, longitude: lon, label: display };
        saveCustomLocation(saved);
        await loadWeather();
        if (weatherOverride) {
          weatherOverride.style.display = 'none';
        }
      } catch (e) {
        console.error('ìœ„ì¹˜ ìˆ˜ë™ ì„¤ì • ì‹¤íŒ¨:', e);
        alert('ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      } finally {
        setLocationBtn.disabled = false;
        setLocationBtn.textContent = 'ì ìš©';
      }
    }

    async function getCoordinates() {
      if (!navigator.geolocation) {
        return { ...DEFAULT_LOCATION, label: DEFAULT_LOCATION.label };
      }

      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            resolve({
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
              label: 'í˜„ì¬ ìœ„ì¹˜'
            });
          },
          () => {
            resolve({ ...DEFAULT_LOCATION, label: DEFAULT_LOCATION.label });
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      });
    }

    async function loadWeather() {
      try {
        weatherError.style.display = 'none';
        weatherDesc.textContent = 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        weatherDate.textContent = formatWeatherDate();
        weatherAdvice.textContent = 'ì˜¤ëŠ˜ì˜ ê³„íš ì¡°ì–¸ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.';
        let coords = loadCustomLocation();

        if (!coords) {
          coords = await getCoordinates();

          // geolocationì´ ê¸°ë³¸ê°’(ì„œìš¸)ë¡œ ë–¨ì–´ì§€ë©´ IP ê¸°ë°˜ ìœ„ì¹˜ ì‹œë„
          if (coords.label === DEFAULT_LOCATION.label) {
            const ipLoc = await fetchIpLocation();
            if (ipLoc) {
              coords = { ...ipLoc };
            }
          }
        }

        let locationLabel = coords.label;
        // ì—­ì§€ì˜¤ì½”ë”©ì€ https í™˜ê²½ì—ì„œë§Œ ì‹œë„í•´ CORS ì˜¤ë¥˜ë¥¼ ì¤„ì¸ë‹¤.
        if (window.isSecureContext) {
          try {
            const cityInfo = await fetchCityName(coords.latitude, coords.longitude);
            if (cityInfo?.label) {
              locationLabel = cityInfo.label;
            }
          } catch (_) {
            // ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ë¼ë²¨ ì‚¬ìš©
          }
        }

        const weather = await fetchWeather(coords.latitude, coords.longitude);
        renderWeather({ locationLabel, weather });
      } catch (error) {
        console.error('ë‚ ì”¨ ë¡œë“œ ì˜¤ë¥˜:', error);
        setWeatherError('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    }

    setLocationBtn.addEventListener('click', applyCustomLocation);
    clearLocationBtn.addEventListener('click', async () => {
      clearCustomLocation();
      customLocationInput.value = '';
      await loadWeather();
    });

    toggleLocationBtn.addEventListener('click', () => {
      if (!weatherOverride) return;
      const isHidden = weatherOverride.style.display === 'none';
      weatherOverride.style.display = isHidden ? 'flex' : 'none';
      if (isHidden) {
        customLocationInput.focus();
      }
    });

    // í• ì¼ ë Œë”ë§
    function renderTodos() {
      todoList.innerHTML = '';
      selectedTodos.clear();

      const filteredTodos = currentFilter 
        ? todos.filter(todo => todo.category === currentFilter)
        : todos;

      if (filteredTodos.length === 0) {
        emptyMessage.style.display = 'block';
        deleteSelectedBtn.style.display = 'none';
        return;
      }

      emptyMessage.style.display = 'none';

      // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
      const today = formatLocalDate();
      const tomorrow = formatLocalDate(1);
      
      const groupedByDate = {};
      const dateOrder = [];
      
      filteredTodos.forEach(todo => {
        const date = todo.dueDate || '9999-12-31';
        if (!groupedByDate[date]) {
          groupedByDate[date] = [];
          dateOrder.push(date);
        }
        groupedByDate[date].push(todo);
      });

      // ë‚ ì§œìˆœ ì •ë ¬
      dateOrder.sort();

      // ì„¹ì…˜ë³„ ë Œë”ë§
      dateOrder.forEach(date => {
        const todos = groupedByDate[date];
        
        let sectionLabel = 'ğŸ“… ë‹¤ë¥¸ ë‚ ì§œ';
        if (date === today) {
          sectionLabel = 'ğŸ“… ì˜¤ëŠ˜';
        } else if (date === tomorrow) {
          sectionLabel = 'ğŸ“… ë‚´ì¼';
        } else if (date !== '9999-12-31') {
          const dateObj = new Date(date);
          sectionLabel = 'ğŸ“… ' + dateObj.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
        }

        // ì„¹ì…˜ ìƒì„±
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'todo-section-group';

        const sectionHeader = document.createElement('div');
        sectionHeader.className = 'todo-section-header';

        const sectionLabel_elem = document.createElement('h3');
        sectionLabel_elem.className = 'todo-section-label';
        sectionLabel_elem.textContent = sectionLabel;

        const deleteAllBtn = document.createElement('button');
        deleteAllBtn.className = 'btn-small btn-delete-all';
        deleteAllBtn.textContent = 'ì¼ê´„ì‚­ì œ';
        deleteAllBtn.addEventListener('click', () => deleteAllTodosInDate(date, todos));

        sectionHeader.appendChild(sectionLabel_elem);
        sectionHeader.appendChild(deleteAllBtn);
        sectionDiv.appendChild(sectionHeader);

        // ì„¹ì…˜ ë‚´ í•­ëª©ë“¤
        todos.forEach(todo => {
          const li = document.createElement('li');
          li.className = `todo-item ${todo.completed ? 'completed' : ''}`;
          li.setAttribute('data-todo-id', todo.id); // ì‚­ì œ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ID ì €ì¥
          const selectCheckbox = document.createElement('input');
          selectCheckbox.type = 'checkbox';
          selectCheckbox.className = 'todo-select';
          selectCheckbox.addEventListener('change', () => {
            if (selectCheckbox.checked) {
              selectedTodos.add(todo.id);
            } else {
              selectedTodos.delete(todo.id);
            }
            updateDeleteButton();
          });

          const text = document.createElement('span');
          text.className = 'todo-text';
          text.textContent = todo.text;

          const category = document.createElement('span');
          category.className = 'todo-category';
          category.textContent = todo.category;

          // ë‚ ì§œ í‘œì‹œ
          const dateLabel = document.createElement('span');
          dateLabel.className = 'todo-date';
          if (todo.dueDate) {
            const dateObj = new Date(todo.dueDate);
            dateLabel.textContent = dateObj.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
          }

          // ì¹´í…Œê³ ë¦¬+ë‚ ì§œ ê·¸ë£¹
          const meta = document.createElement('div');
          meta.className = 'todo-meta';
          meta.appendChild(category);
          meta.appendChild(dateLabel);

          const actions = document.createElement('div');
          actions.className = 'todo-actions';

          const completeBtn = document.createElement('button');
          completeBtn.className = 'btn-small btn-complete';
          if (todo.completed) {
            completeBtn.textContent = 'ì™„ë£Œë¨';
            completeBtn.disabled = true;
          } else {
            completeBtn.textContent = 'ì™„ë£Œ';
            completeBtn.addEventListener('click', () => toggleTodo(todo.id));
          }

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn-small btn-delete';
          deleteBtn.textContent = 'ì‚­ì œ';
          deleteBtn.addEventListener('click', () => deleteTodo(todo.id));

          actions.appendChild(completeBtn);
          actions.appendChild(deleteBtn);

          li.appendChild(selectCheckbox);
          li.appendChild(text);
          li.appendChild(meta);
          li.appendChild(actions);

          sectionDiv.appendChild(li);
        });

        todoList.appendChild(sectionDiv);
      });
    }

    function updateDeleteButton() {
      if (selectedTodos.size > 0) {
        deleteSelectedBtn.style.display = 'block';
        deleteSelectedBtn.textContent = `ì„ íƒ ì‚­ì œ (${selectedTodos.size}ê°œ)`;
      } else {
        deleteSelectedBtn.style.display = 'none';
      }
    }

    function xpNeededForLevel(level) {
      return BASE_XP_FOR_LEVEL + (level - 1) * LEVEL_GROWTH;
    }

    function titleForLevel(level) {
      if (level >= 50) return 'ì „ì„¤ì˜ í”Œë˜ë„ˆ';
      if (level >= 33) return 'ì˜í–¥ë ¥ ë¦¬ë”';
      if (level >= 25) return 'ìƒì‚°ì„± ë§ˆìŠ¤í„°';
      if (level >= 18) return 'ì‹œê°„ ì „ëµê°€';
      if (level >= 13) return 'ìŠµê´€ ì¥ì¸';
      if (level >= 9) return 'ëª©í‘œ ë‹¬ì„±ê°€';
      if (level >= 6) return 'ëª°ì…í˜• í¼í¬ë¨¸';
      if (level >= 4) return 'ì„±ì¥í•˜ëŠ” í”Œë˜ë„ˆ';
      if (level >= 2) return 'ê¾¸ì¤€í•œ ì‹¤í–‰ê°€';
      return 'ìƒˆì‹¹ ë„ì „ì';
    }

    function nextTitleInfo(level) {
      const thresholds = [
        { level: 2, title: 'ê¾¸ì¤€í•œ ì‹¤í–‰ê°€' },
        { level: 4, title: 'ì„±ì¥í•˜ëŠ” í”Œë˜ë„ˆ' },
        { level: 6, title: 'ëª°ì…í˜• í¼í¬ë¨¸' },
        { level: 9, title: 'ëª©í‘œ ë‹¬ì„±ê°€' },
        { level: 13, title: 'ìŠµê´€ ì¥ì¸' },
        { level: 18, title: 'ì‹œê°„ ì „ëµê°€' },
        { level: 25, title: 'ìƒì‚°ì„± ë§ˆìŠ¤í„°' },
        { level: 33, title: 'ì˜í–¥ë ¥ ë¦¬ë”' },
        { level: 50, title: 'ì „ì„¤ì˜ í”Œë˜ë„ˆ' }
      ];
      return thresholds.find(t => t.level > level) || null;
    }

    function computeLevelProgress(xp) {
      let level = 1;
      let xpLeft = xp;

      while (true) {
        const need = xpNeededForLevel(level);
        if (xpLeft < need) {
          return { level, xpIntoLevel: xpLeft, xpNeeded: need };
        }
        xpLeft -= need;
        level += 1;
      }
    }

    function updateStatusUI() {
      const progress = computeLevelProgress(userStats.xp);
      userStats.level = progress.level;

      levelValue.textContent = progress.level;
      xpValue.textContent = userStats.xp;
      const remain = progress.xpNeeded - progress.xpIntoLevel;
      xpProgressText.textContent = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${remain} XP`;
      titleValue.textContent = titleForLevel(progress.level);
      const nextTitle = nextTitleInfo(progress.level);
      nextTitleText.textContent = nextTitle
        ? `ë‹¤ìŒ ì¹­í˜¸: ${nextTitle.title} (Lv. ${nextTitle.level})`
        : 'ìµœê³  ì¹­í˜¸ ë‹¬ì„±!';
    }

    async function loadUserStats() {
      if (!currentUser) return;
      try {
        const snap = await getDoc(doc(db, 'users', currentUser.uid));
        if (snap.exists()) {
          const data = snap.data();
          userStats.xp = data.xp ?? 0;
          const progress = computeLevelProgress(userStats.xp);
          userStats.level = data.level ?? progress.level;

          // í•„ë“œê°€ ì—†ê±°ë‚˜ ìƒˆ ê³¡ì„ ê³¼ ë¶ˆì¼ì¹˜í•˜ë©´ ë³´ì •
          if (data.xp === undefined || data.level === undefined || data.level !== progress.level) {
            await updateDoc(doc(db, 'users', currentUser.uid), {
              xp: userStats.xp,
              level: progress.level
            });
          }
        }
      } catch (error) {
        console.error('ì‚¬ìš©ì ê²½í—˜ì¹˜ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
      updateStatusUI();
    }

    // í• ì¼ ì™„ë£Œ ì²˜ë¦¬ (ì™„ë£Œ ì·¨ì†Œ ë¶ˆê°€)
    async function toggleTodo(id) {
      try {
        const target = todos.find(t => t.id === id);
        if (!target || target.completed) return;

        const todayStr = formatLocalDate();
        await updateDoc(doc(db, 'todos', id), {
          completed: true,
          completedDate: todayStr
        });

        await runTransaction(db, async (transaction) => {
          const userRef = doc(db, 'users', currentUser.uid);
          const userSnap = await transaction.get(userRef);
          const currentXp = userSnap.exists() ? (userSnap.data().xp || 0) : 0;
          const newXp = currentXp + XP_PER_TODO;
          const progress = computeLevelProgress(newXp);
          const newLevel = progress.level;
          if (userSnap.exists()) {
            transaction.update(userRef, { xp: newXp, level: newLevel });
          } else {
            transaction.set(userRef, { xp: newXp, level: newLevel }, { merge: true });
          }
          userStats.xp = newXp;
          userStats.level = newLevel;
        });

        updateStatusUI();
        await loadTodos();
      } catch (error) {
        console.error('í• ì¼ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      }
    }

    // í• ì¼ ì‚­ì œ
    async function deleteTodo(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
          // ì‚­ì œí•  í•­ëª© ì°¾ê¸°
          const todoElement = document.querySelector(`[data-todo-id="${id}"]`);
          
          if (todoElement) {
            // ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
            todoElement.classList.add('removing');
            
            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì‚­ì œ
            await new Promise(resolve => {
              setTimeout(resolve, 400); // ì• ë‹ˆë©”ì´ì…˜ ì§€ì†ì‹œê°„ê³¼ ì¼ì¹˜
            });
          }
          
          await deleteDoc(doc(db, 'todos', id));
          console.log('âœ… í• ì¼ ì‚­ì œ ì™„ë£Œ:', id);
          await loadTodos();
        } catch (error) {
          console.error('í• ì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
        }
      }
    }

    // ì„ íƒ ì‚­ì œ
    deleteSelectedBtn.addEventListener('click', async () => {
      if (selectedTodos.size === 0) {
        alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      if (confirm(`${selectedTodos.size}ê°œì˜ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        try {
          // ì‚­ì œí•  í•­ëª©ë“¤ì— ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
          const selectedArray = Array.from(selectedTodos);
          selectedArray.forEach(id => {
            const todoElement = document.querySelector(`[data-todo-id="${id}"]`);
            if (todoElement) {
              todoElement.classList.add('removing');
            }
          });

          // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì‚­ì œ
          await new Promise(resolve => {
            setTimeout(resolve, 400);
          });

          for (let id of selectedTodos) {
            await deleteDoc(doc(db, 'todos', id));
          }
          console.log('âœ… ì„ íƒ í•­ëª© ì‚­ì œ ì™„ë£Œ');
          await loadTodos();
        } catch (error) {
          console.error('ì„ íƒ ì‚­ì œ ì˜¤ë¥˜:', error);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }
    });

    // ë‚ ì§œë³„ ì¼ê´„ ì‚­ì œ
    async function deleteAllTodosInDate(date, todosInDate) {
      if (todosInDate.length === 0) {
        alert('ì‚­ì œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (confirm(`ì´ ë‚ ì§œì˜ ëª¨ë“  í•­ëª©(${todosInDate.length}ê°œ)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        try {
          for (let todo of todosInDate) {
            await deleteDoc(doc(db, 'todos', todo.id));
          }
          console.log('âœ… ë‚ ì§œë³„ ì¼ê´„ ì‚­ì œ ì™„ë£Œ');
          await loadTodos();
        } catch (error) {
          console.error('ì¼ê´„ ì‚­ì œ ì˜¤ë¥˜:', error);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }
    }

    // í–„ë²„ê±° ë©”ë‰´ í† ê¸€
    function setupHamburgerMenu() {
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      const navMenu = document.getElementById('navMenu');

      console.log('ğŸ” í–„ë²„ê±° ë©”ë‰´ ì„¤ì •:', { hamburgerBtn, navMenu });

      if (!hamburgerBtn || !navMenu) {
        console.error('âŒ í–„ë²„ê±° ë²„íŠ¼ ë˜ëŠ” ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // í–„ë²„ê±° ë²„íŠ¼ í´ë¦­
      hamburgerBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('âœ… í–„ë²„ê±° ë²„íŠ¼ í´ë¦­ë¨');
        hamburgerBtn.classList.toggle('active');
        navMenu.classList.toggle('active');
      });

      // ë©”ë‰´ ë§í¬ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
      const navLinks = navMenu.querySelectorAll('a');
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          console.log('ğŸ“ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ í´ë¦­:', link.href);
          hamburgerBtn.classList.remove('active');
          navMenu.classList.remove('active');
        });
      });

      // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
      document.addEventListener('click', (e) => {
        if (!e.target.closest('header')) {
          hamburgerBtn.classList.remove('active');
          navMenu.classList.remove('active');
        }
      });

      console.log('âœ… í–„ë²„ê±° ë©”ë‰´ ì„¤ì • ì™„ë£Œ');
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„°
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.category;
        renderTodos();
      });
    });

  </script>
</body>
</html>
